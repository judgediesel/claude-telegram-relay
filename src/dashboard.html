<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raya</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            surface: { 900: '#0a0e1a', 800: '#111827', 700: '#1a2035', 600: '#242d42' },
            accent: { DEFAULT: '#6366f1', light: '#818cf8', dim: '#4f46e5' },
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    body { background: #0a0e1a; color: #e2e8f0; }

    .glass {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.1);
      border-radius: 16px;
    }

    .glass-strong {
      background: rgba(26, 32, 53, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 16px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.02));
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(99, 102, 241, 0.1);
    }

    .tab {
      cursor: pointer;
      padding: 0.6rem 1.2rem;
      border-radius: 10px;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 0.875rem;
      color: #94a3b8;
    }
    .tab:hover { background: rgba(99, 102, 241, 0.1); color: #c7d2fe; }
    .tab-active {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .msg-bubble {
      border-radius: 12px;
      padding: 0.75rem 1rem;
      max-width: 85%;
      line-height: 1.5;
    }
    .msg-user {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .msg-assistant {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(99, 102, 241, 0.1);
      border-bottom-left-radius: 4px;
    }

    .streak-fire { color: #f59e0b; }
    .status-done { color: #22c55e; }
    .status-pending { color: #f97316; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.025em;
      text-transform: uppercase;
    }

    .progress-ring {
      width: 80px;
      height: 80px;
    }
    .progress-ring circle {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
    }

    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .btn {
      cursor: pointer;
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      outline: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
    }
    .btn-primary:hover { box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-success {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .btn-success:hover { background: rgba(34, 197, 94, 0.25); }
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.15);
    }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }
    .btn-ghost {
      background: rgba(99, 102, 241, 0.08);
      color: #94a3b8;
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .btn-ghost:hover { background: rgba(99, 102, 241, 0.15); color: #c7d2fe; }

    .input-field {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 10px;
      padding: 0.5rem 0.75rem;
      color: #e2e8f0;
      font-size: 0.875rem;
      outline: none;
      transition: border-color 0.2s;
      width: 100%;
    }
    .input-field:focus { border-color: rgba(99, 102, 241, 0.4); }
    .input-field::placeholder { color: #475569; }

    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 500;
      z-index: 100;
      animation: slideUp 0.3s ease-out, fadeOut 0.3s ease-in 2.5s forwards;
    }
    .toast-success { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .toast-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { to { opacity: 0; } }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-50 glass px-6 py-4 mx-4 mt-4 flex items-center justify-between" style="border-radius: 16px;">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent to-purple-600 flex items-center justify-center font-bold text-white text-lg shadow-lg shadow-accent/20">R</div>
      <div>
        <h1 class="text-xl font-bold text-white tracking-tight">Raya</h1>
        <div id="status-line" class="text-xs text-slate-500">Loading...</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div id="live-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
      <span class="text-xs text-slate-500" id="uptime-display">--</span>
    </div>
  </header>

  <!-- Message Input Bar -->
  <div class="mx-4 mt-3">
    <div class="glass px-4 py-3 flex gap-3 items-center" style="border-radius: 12px;">
      <input type="text" id="msg-input" class="input-field flex-1" placeholder="Talk to Raya..." onkeydown="if(event.key==='Enter')sendMessage()" />
      <button id="msg-btn" class="btn btn-primary px-4 py-2" onclick="sendMessage()">Send</button>
    </div>
    <div id="msg-response" class="hidden mt-2 glass-strong p-4 text-sm text-slate-300" style="border-radius: 12px;"></div>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Tabs -->
    <nav class="flex gap-2 mb-6 flex-wrap" id="tabs">
      <div class="tab tab-active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="messages">Messages</div>
      <div class="tab" data-tab="memory">Memory</div>
      <div class="tab" data-tab="contacts">Contacts</div>
      <div class="tab" data-tab="todos">Todos</div>
      <div class="tab" data-tab="habits">Habits</div>
      <div class="tab" data-tab="ads">Ads</div>
      <div class="tab" data-tab="logs">Logs</div>
    </nav>

    <!-- Content -->
    <div id="content" class="fade-in"></div>
  </main>

  <!-- Toast container -->
  <div id="toast-container"></div>

  <script>
    const TOKEN = "__TOKEN__";
    const BASE = window.location.origin;

    async function api(path) {
      const res = await fetch(`${BASE}${path}?token=${TOKEN}`);
      return res.json();
    }

    async function apiPost(path, body) {
      const res = await fetch(`${BASE}${path}?token=${TOKEN}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      return res.json();
    }

    function toast(message, type = "success") {
      const el = document.createElement("div");
      el.className = `toast toast-${type}`;
      el.textContent = message;
      document.getElementById("toast-container").appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function timeAgo(dateStr) {
      if (!dateStr) return "";
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      const days = Math.floor(hrs / 24);
      if (days < 7) return `${days}d ago`;
      return `${Math.floor(days / 7)}w ago`;
    }

    function formatTime(dateStr) {
      return new Date(dateStr).toLocaleString("en-US", {
        month: "short", day: "numeric", hour: "numeric", minute: "2-digit"
      });
    }

    function esc(str) {
      const d = document.createElement("div");
      d.textContent = str || "";
      return d.innerHTML;
    }

    function progressCircle(done, total, color = "#6366f1") {
      const pct = total > 0 ? done / total : 0;
      const r = 34;
      const c = 2 * Math.PI * r;
      const offset = c * (1 - pct);
      return `
        <svg class="progress-ring" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="${r}" stroke="rgba(99,102,241,0.1)" />
          <circle cx="40" cy="40" r="${r}" stroke="${color}" stroke-dasharray="${c}" stroke-dashoffset="${offset}"
            transform="rotate(-90 40 40)" style="transition: stroke-dashoffset 1s ease;" />
          <text x="40" y="36" text-anchor="middle" fill="white" font-size="18" font-weight="700">${done}</text>
          <text x="40" y="50" text-anchor="middle" fill="#64748b" font-size="10">of ${total}</text>
        </svg>
      `;
    }

    // ---- Send Message ----
    async function sendMessage() {
      const input = document.getElementById("msg-input");
      const btn = document.getElementById("msg-btn");
      const responseDiv = document.getElementById("msg-response");
      const msg = input.value.trim();
      if (!msg) return;

      input.disabled = true;
      btn.disabled = true;
      btn.textContent = "...";
      responseDiv.classList.remove("hidden");
      responseDiv.innerHTML = '<div class="flex items-center gap-2"><div class="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div><span class="text-slate-500">Raya is thinking...</span></div>';

      try {
        const result = await apiPost("/api/send-message", { message: msg });
        if (result.ok && result.response) {
          responseDiv.innerHTML = `<div class="text-xs text-indigo-400 mb-1 font-medium">Raya</div><div class="whitespace-pre-wrap">${esc(result.response)}</div>`;
          input.value = "";
          toast("Message sent");
        } else {
          responseDiv.innerHTML = `<div class="text-red-400">${esc(result.error || "Failed to send")}</div>`;
        }
      } catch (err) {
        responseDiv.innerHTML = '<div class="text-red-400">Connection error</div>';
      }

      input.disabled = false;
      btn.disabled = false;
      btn.textContent = "Send";
      input.focus();
    }

    // ---- Habit Actions ----
    async function completeHabit(id) {
      const result = await apiPost("/api/habits/complete", { id });
      if (result.ok) {
        toast(result.message || `Done! Streak: ${result.streak || 1}`);
        tabHandlers[currentTab]?.();
      } else {
        toast("Failed to complete habit", "error");
      }
    }

    async function removeHabit(id, name) {
      if (!confirm(`Remove habit "${name}"?`)) return;
      const result = await apiPost("/api/habits/remove", { id });
      if (result.ok) {
        toast("Habit removed");
        tabHandlers[currentTab]?.();
      }
    }

    async function addHabit() {
      const desc = document.getElementById("new-habit-input")?.value?.trim();
      const freq = document.getElementById("new-habit-freq")?.value || "daily";
      if (!desc) return;
      const result = await apiPost("/api/habits/create", { description: desc, frequency: freq });
      if (result.ok) {
        toast("Habit added");
        document.getElementById("new-habit-input").value = "";
        tabHandlers[currentTab]?.();
      }
    }

    // ---- Todo Actions ----
    async function completeTodo(id) {
      const result = await apiPost("/api/todos/complete", { id });
      if (result.ok) {
        toast("Todo completed");
        tabHandlers[currentTab]?.();
      }
    }

    async function addTodo() {
      const content = document.getElementById("new-todo-input")?.value?.trim();
      const due = document.getElementById("new-todo-due")?.value || "";
      if (!content) return;
      const result = await apiPost("/api/todos/create", { content, dueDate: due || undefined });
      if (result.ok) {
        toast("Todo added");
        document.getElementById("new-todo-input").value = "";
        if (document.getElementById("new-todo-due")) document.getElementById("new-todo-due").value = "";
        tabHandlers[currentTab]?.();
      }
    }

    // ---- Tab Renderers ----
    async function showOverview() {
      const [stats, todos, habits, msgs] = await Promise.all([
        api("/api/stats"), api("/api/todos"), api("/api/habits"), api("/api/messages"),
      ]);

      const upH = Math.floor((stats.uptime || 0) / 3600);
      const upM = Math.floor(((stats.uptime || 0) % 3600) / 60);
      document.getElementById("uptime-display").textContent = `${upH}h ${upM}m`;
      document.getElementById("status-line").textContent = `Personal AI Assistant`;

      const todayStr = new Date().toLocaleDateString("en-US");
      const habitsData = habits.habits || [];
      const habitsDone = habitsData.filter(h =>
        h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr
      ).length;
      const activeTodos = (todos.active || []).length;
      const recentMsgs = (msgs.messages || []).slice(0, 6);

      document.getElementById("content").innerHTML = `
        <div class="fade-in">
          <!-- Stats Grid -->
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="stat-card p-5 text-center">
              <div class="text-3xl font-bold text-indigo-400 mb-1">${stats.messages || 0}</div>
              <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Messages</div>
            </div>
            <div class="stat-card p-5 text-center">
              <div class="text-3xl font-bold text-cyan-400 mb-1">${stats.facts || 0}</div>
              <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Memories</div>
            </div>
            <div class="stat-card p-5 text-center">
              <div class="text-3xl font-bold text-violet-400 mb-1">${stats.goals || 0}</div>
              <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Goals</div>
            </div>
            <div class="stat-card p-5 text-center">
              <div class="text-3xl font-bold text-amber-400 mb-1">${activeTodos}</div>
              <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Todos</div>
            </div>
            <div class="stat-card p-5 text-center col-span-2 md:col-span-1">
              <div class="text-3xl font-bold text-emerald-400 mb-1">${habitsDone}<span class="text-lg text-slate-600">/${habitsData.length}</span></div>
              <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Habits Today</div>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <!-- Recent Conversations -->
            <div class="glass-strong p-5 md:col-span-2">
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Recent Conversations</h3>
              <div class="space-y-3">
                ${recentMsgs.map(m => `
                  <div class="flex gap-3 items-start">
                    <div class="w-7 h-7 rounded-lg flex-shrink-0 flex items-center justify-center text-xs font-bold mt-0.5
                      ${m.role === "user" ? "bg-indigo-500/20 text-indigo-300" : "bg-emerald-500/20 text-emerald-300"}">
                      ${m.role === "user" ? "M" : "R"}
                    </div>
                    <div class="min-w-0">
                      <div class="flex items-center gap-2 mb-0.5">
                        <span class="text-xs font-medium ${m.role === "user" ? "text-indigo-400" : "text-emerald-400"}">${m.role === "user" ? "Mark" : "Raya"}</span>
                        <span class="text-xs text-slate-600">${timeAgo(m.created_at)}</span>
                        ${m.metadata?.source ? `<span class="badge bg-slate-800 text-slate-500">${m.metadata.source}</span>` : ""}
                      </div>
                      <div class="text-sm text-slate-400 leading-relaxed">${esc(m.content?.substring(0, 150))}${m.content?.length > 150 ? "..." : ""}</div>
                    </div>
                  </div>
                `).join("") || '<div class="text-slate-600 text-sm">No messages yet</div>'}
              </div>
            </div>

            <!-- Habits Sidebar -->
            <div class="glass-strong p-5">
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Today's Habits</h3>
              <div class="flex justify-center mb-4">
                ${progressCircle(habitsDone, habitsData.length, "#22c55e")}
              </div>
              <div class="space-y-2.5">
                ${habitsData.map(h => {
                  const done = h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr;
                  const streak = h.priority || 0;
                  return `
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2 min-w-0">
                        ${done
                          ? `<div class="w-5 h-5 rounded-md flex items-center justify-center text-xs bg-emerald-500/20 text-emerald-400">&#10003;</div>`
                          : `<button onclick="completeHabit('${h.id}')" class="w-5 h-5 rounded-md border-2 border-emerald-500/30 hover:bg-emerald-500/20 transition-colors cursor-pointer flex-shrink-0" title="Mark done"></button>`
                        }
                        <span class="text-sm ${done ? "text-slate-300" : "text-slate-500"} truncate">${esc(h.content)}</span>
                      </div>
                      ${streak > 0 ? `<span class="text-xs streak-fire flex-shrink-0">${streak}d</span>` : ""}
                    </div>
                  `;
                }).join("") || '<div class="text-slate-600 text-sm text-center">No habits yet</div>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function showMessages() {
      const data = await api("/api/messages");
      const msgs = data.messages || [];
      document.getElementById("content").innerHTML = `
        <div class="glass-strong p-5 fade-in">
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-5">Conversation History</h3>
          <div class="space-y-3 max-w-3xl mx-auto">
            ${[...msgs].reverse().map(m => `
              <div class="flex ${m.role === "user" ? "justify-end" : "justify-start"}">
                <div>
                  <div class="msg-bubble ${m.role === "user" ? "msg-user" : "msg-assistant"}">
                    <div class="text-sm whitespace-pre-wrap">${esc(m.content?.substring(0, 500))}${m.content?.length > 500 ? "..." : ""}</div>
                  </div>
                  <div class="text-xs text-slate-600 mt-1 ${m.role === "user" ? "text-right" : ""} px-1">
                    ${formatTime(m.created_at)}
                    ${m.metadata?.source ? ` &middot; ${m.metadata.source}` : ""}
                  </div>
                </div>
              </div>
            `).join("") || '<div class="text-slate-600 text-center py-8">No messages yet</div>'}
          </div>
        </div>
      `;
    }

    async function showMemory() {
      const data = await api("/api/memory");
      // Filter out contacts from facts display
      const facts = (data.facts || []).filter(f => !f.content?.startsWith("[CONTACT]"));

      document.getElementById("content").innerHTML = `
        <div class="fade-in">
          <!-- Semantic Search -->
          <div class="glass-strong p-4 mb-4 flex gap-3 items-center">
            <input type="text" id="memory-search-input" class="input-field flex-1" placeholder="Search memory semantically..." onkeydown="if(event.key==='Enter')searchMemoryUI()" />
            <button onclick="searchMemoryUI()" class="btn btn-primary px-4 py-2">Search</button>
          </div>
          <div id="memory-search-results" class="hidden mb-4"></div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="glass-strong p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Memories</h3>
                <span class="badge bg-cyan-500/10 text-cyan-400">${facts.length}</span>
              </div>
              <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                ${facts.map(f => `
                  <div class="flex gap-2 items-start group">
                    <div class="w-1.5 h-1.5 rounded-full bg-cyan-500/50 mt-2 flex-shrink-0"></div>
                    <span class="text-sm text-slate-400 leading-relaxed">${esc(f.content)}</span>
                  </div>
                `).join("") || '<div class="text-slate-600 text-sm">No memories stored yet</div>'}
              </div>
            </div>
            <div class="space-y-4">
              <div class="glass-strong p-5">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Active Goals</h3>
                  <span class="badge bg-violet-500/10 text-violet-400">${(data.goals || []).length}</span>
                </div>
                <div class="space-y-2">
                  ${(data.goals || []).map(g => `
                    <div class="flex gap-2 items-start">
                      <div class="w-1.5 h-1.5 rounded-full bg-violet-500/50 mt-2 flex-shrink-0"></div>
                      <div>
                        <span class="text-sm text-slate-300">${esc(g.content)}</span>
                        ${g.deadline ? `<span class="text-xs text-amber-400/80 ml-1">by ${g.deadline}</span>` : ""}
                      </div>
                    </div>
                  `).join("") || '<div class="text-slate-600 text-sm">No active goals</div>'}
                </div>
              </div>
              <div class="glass-strong p-5">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Completed Goals</h3>
                <div class="space-y-2">
                  ${(data.completedGoals || []).map(g => `
                    <div class="flex gap-2 items-start">
                      <span class="text-emerald-500 text-xs mt-0.5">&#10003;</span>
                      <span class="text-sm text-slate-600 line-through">${esc(g.content)}</span>
                    </div>
                  `).join("") || '<div class="text-slate-600 text-sm">None yet</div>'}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function searchMemoryUI() {
      const input = document.getElementById("memory-search-input");
      const resultsDiv = document.getElementById("memory-search-results");
      const q = input.value.trim();
      if (!q) return;

      resultsDiv.classList.remove("hidden");
      resultsDiv.innerHTML = '<div class="glass-strong p-4"><div class="flex items-center gap-2"><div class="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div><span class="text-slate-500 text-sm">Searching...</span></div></div>';

      const data = await api(`/api/memory-search?q=${encodeURIComponent(q)}`);
      const results = data.results || [];

      resultsDiv.innerHTML = `
        <div class="glass-strong p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Search Results</h3>
            <span class="badge bg-indigo-500/10 text-indigo-400">${results.length} matches</span>
          </div>
          <div class="space-y-2">
            ${results.map(r => `
              <div class="flex gap-3 items-start p-2.5 rounded-lg bg-slate-800/30">
                <div class="text-xs text-indigo-400 font-mono w-10 flex-shrink-0 text-right mt-0.5">${r.score}</div>
                <span class="text-sm text-slate-300">${esc(r.content)}</span>
              </div>
            `).join("") || '<div class="text-slate-600 text-sm text-center py-2">No matches found</div>'}
          </div>
        </div>
      `;
    }

    async function showContacts() {
      const data = await api("/api/contacts");
      const contacts = data.contacts || [];

      document.getElementById("content").innerHTML = `
        <div class="fade-in">
          <div class="glass-strong p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Contacts</h3>
              <span class="badge bg-pink-500/10 text-pink-400">${contacts.length}</span>
            </div>
            <div class="space-y-3">
              ${contacts.map(c => {
                const parts = c.content.split(" | ");
                const name = parts[0] || "Unknown";
                const details = parts.slice(1);
                return `
                  <div class="p-4 rounded-xl bg-slate-800/30 border border-slate-700/30">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-9 h-9 rounded-xl bg-pink-500/15 flex items-center justify-center text-pink-400 font-bold text-sm">${esc(name.charAt(0).toUpperCase())}</div>
                      <div>
                        <div class="text-sm font-medium text-white">${esc(name)}</div>
                        <div class="text-xs text-slate-600">${c.updated_at ? "Updated " + timeAgo(c.updated_at) : "Added " + timeAgo(c.created_at)}</div>
                      </div>
                    </div>
                    ${details.length > 0 ? `
                      <div class="ml-12 space-y-1">
                        ${details.map(d => {
                          const [key, ...vals] = d.split(":");
                          const val = vals.join(":").trim();
                          return `<div class="text-xs"><span class="text-slate-600">${esc(key.trim())}:</span> <span class="text-slate-400">${esc(val)}</span></div>`;
                        }).join("")}
                      </div>
                    ` : ""}
                  </div>
                `;
              }).join("") || '<div class="text-slate-600 text-sm text-center py-8">No contacts saved yet. Tell Raya about someone and she\'ll remember them.</div>'}
            </div>
          </div>
        </div>
      `;
    }

    async function showTodos() {
      const data = await api("/api/todos");
      const active = data.active || [];
      const completed = data.completed || [];

      document.getElementById("content").innerHTML = `
        <div class="fade-in">
          <!-- Add Todo Form -->
          <div class="glass-strong p-4 mb-4 flex gap-3 items-center flex-wrap">
            <input type="text" id="new-todo-input" class="input-field flex-1 min-w-[200px]" placeholder="Add a new todo..." onkeydown="if(event.key==='Enter')addTodo()" />
            <input type="date" id="new-todo-due" class="input-field w-auto" style="max-width: 160px;" />
            <button onclick="addTodo()" class="btn btn-primary px-4 py-2">Add</button>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="glass-strong p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Active</h3>
                <span class="badge bg-amber-500/10 text-amber-400">${active.length}</span>
              </div>
              <div class="space-y-2.5">
                ${active.map(t => `
                  <div class="flex items-start gap-3 p-2.5 rounded-lg bg-slate-800/30 group">
                    <button onclick="completeTodo('${t.id}')" class="w-5 h-5 rounded-md border-2 border-amber-500/30 hover:bg-emerald-500/20 hover:border-emerald-500/30 transition-colors cursor-pointer flex-shrink-0 mt-0.5" title="Complete"></button>
                    <div class="min-w-0 flex-1">
                      <div class="text-sm text-slate-300">${esc(t.content)}</div>
                      ${t.deadline ? `<div class="text-xs text-amber-400/60 mt-0.5">Due: ${t.deadline}</div>` : ""}
                    </div>
                  </div>
                `).join("") || '<div class="text-slate-600 text-sm text-center py-4">All clear!</div>'}
              </div>
            </div>
            <div class="glass-strong p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Completed</h3>
                <span class="badge bg-emerald-500/10 text-emerald-400">${completed.length}</span>
              </div>
              <div class="space-y-2.5">
                ${completed.map(t => `
                  <div class="flex items-start gap-3 p-2.5 rounded-lg">
                    <div class="w-5 h-5 rounded-md bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-xs flex-shrink-0 mt-0.5">&#10003;</div>
                    <div class="min-w-0">
                      <div class="text-sm text-slate-600 line-through">${esc(t.content)}</div>
                      <div class="text-xs text-slate-700 mt-0.5">${timeAgo(t.completed_at)}</div>
                    </div>
                  </div>
                `).join("") || '<div class="text-slate-600 text-sm text-center py-4">None completed yet</div>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function showHabits() {
      const data = await api("/api/habits");
      const habits = data.habits || [];
      const todayStr = new Date().toLocaleDateString("en-US");
      const done = habits.filter(h => h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr).length;

      document.getElementById("content").innerHTML = `
        <div class="fade-in">
          <!-- Add Habit Form -->
          <div class="glass-strong p-4 mb-4 flex gap-3 items-center flex-wrap">
            <input type="text" id="new-habit-input" class="input-field flex-1 min-w-[200px]" placeholder="Add a new habit..." onkeydown="if(event.key==='Enter')addHabit()" />
            <select id="new-habit-freq" class="input-field w-auto" style="max-width: 130px; background-color: rgba(15,23,42,0.8);">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
            <button onclick="addHabit()" class="btn btn-primary px-4 py-2">Add</button>
          </div>

          <div class="glass-strong p-6 mb-4 flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-white">Daily Habits</h3>
              <p class="text-sm text-slate-500 mt-1">${done} of ${habits.length} completed today</p>
            </div>
            ${progressCircle(done, habits.length, "#22c55e")}
          </div>

          <div class="space-y-3">
            ${habits.map(h => {
              const isDone = h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr;
              const streak = h.priority || 0;
              return `
                <div class="glass-strong p-4 flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    ${isDone
                      ? `<div class="w-8 h-8 rounded-xl flex items-center justify-center text-sm bg-emerald-500/20 text-emerald-400">&#10003;</div>`
                      : `<button onclick="completeHabit('${h.id}')" class="w-8 h-8 rounded-xl flex items-center justify-center text-sm bg-slate-700/50 text-slate-500 hover:bg-emerald-500/20 hover:text-emerald-400 transition-colors cursor-pointer" title="Mark done">&#9675;</button>`
                    }
                    <div>
                      <div class="text-sm font-medium ${isDone ? "text-slate-200" : "text-slate-400"}">${esc(h.content)}</div>
                      <div class="text-xs text-slate-600">${h.deadline || "daily"} ${h.updated_at ? `&middot; Last: ${timeAgo(h.updated_at)}` : ""}</div>
                    </div>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="text-right">
                      ${streak > 0 ? `
                        <div class="streak-fire text-lg font-bold">${streak}</div>
                        <div class="text-xs text-slate-600">day streak</div>
                      ` : '<div class="text-xs text-slate-700">No streak</div>'}
                    </div>
                    <button onclick="removeHabit('${h.id}', '${esc(h.content).replace(/'/g, "\\\'")}')" class="btn btn-danger text-xs opacity-0 group-hover:opacity-100" title="Remove">&#10005;</button>
                  </div>
                </div>
              `;
            }).join("") || '<div class="glass-strong p-8 text-slate-600 text-center">No habits tracked yet</div>'}
          </div>
        </div>
      `;
    }

    async function showLogs() {
      const data = await api("/api/logs");
      const logs = data.logs || [];

      document.getElementById("content").innerHTML = `
        <div class="glass-strong p-5 fade-in">
          <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">System Logs</h3>
          <div class="space-y-1">
            ${logs.map(l => {
              const isYes = l.metadata?.decision === "YES";
              const isNo = l.metadata?.decision === "NO";
              return `
                <div class="flex items-start gap-3 py-2.5 border-b border-slate-800/50 text-sm">
                  <div class="text-xs text-slate-600 whitespace-nowrap w-32 flex-shrink-0 pt-0.5">${formatTime(l.created_at)}</div>
                  <div class="flex-shrink-0">
                    <span class="badge ${isYes ? "bg-emerald-500/10 text-emerald-400" : isNo ? "bg-slate-700 text-slate-500" : "bg-indigo-500/10 text-indigo-400"}">${esc(l.event)}</span>
                  </div>
                  <div class="text-slate-500 truncate">${esc(l.message?.substring(0, 200))}</div>
                </div>
              `;
            }).join("") || '<div class="text-slate-600 text-center py-8">No logs yet</div>'}
          </div>
        </div>
      `;
    }

    async function showAds() {
      const data = await api("/api/ads");
      const metrics = data.metrics || [];
      const alerts = data.alerts || [];
      const lastCheck = data.lastCheck ? formatTime(data.lastCheck) : "Never";

      const totalSpend = metrics.reduce((s, m) => s + m.spend, 0);
      const totalClicks = metrics.reduce((s, m) => s + m.clicks, 0);
      const totalConv = metrics.reduce((s, m) => s + m.conversions, 0);
      const totalImpr = metrics.reduce((s, m) => s + m.impressions, 0);

      document.getElementById("content").innerHTML = `
        <div class="space-y-4 fade-in">
          ${!data.metaEnabled && !data.googleEnabled ? `
            <div class="glass-strong p-8 text-center">
              <div class="text-3xl mb-3">ðŸ“Š</div>
              <div class="text-slate-400 mb-2">Ad monitoring not configured</div>
              <div class="text-slate-600 text-sm">Set META_ACCESS_TOKEN + META_AD_ACCOUNT_IDS or GOOGLE_ADS_* env vars</div>
            </div>
          ` : `
            <!-- Summary cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="stat-card p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Total Spend</div>
                <div class="text-2xl font-bold text-white mt-1">$${totalSpend.toFixed(0)}</div>
                <div class="text-xs text-slate-500 mt-1">today</div>
              </div>
              <div class="stat-card p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Impressions</div>
                <div class="text-2xl font-bold text-white mt-1">${totalImpr.toLocaleString()}</div>
              </div>
              <div class="stat-card p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Clicks</div>
                <div class="text-2xl font-bold text-white mt-1">${totalClicks.toLocaleString()}</div>
              </div>
              <div class="stat-card p-4">
                <div class="text-xs text-slate-500 uppercase tracking-wider">Conversions</div>
                <div class="text-2xl font-bold text-white mt-1">${totalConv.toFixed(0)}</div>
              </div>
            </div>

            ${alerts.length > 0 ? `
              <div class="glass-strong p-5">
                <h3 class="text-sm font-semibold text-red-400 uppercase tracking-wider mb-3">Alerts</h3>
                <div class="space-y-2">
                  ${alerts.map(a => `
                    <div class="flex items-start gap-3 p-3 rounded-lg ${a.severity === 'critical' ? 'bg-red-500/10 border border-red-500/20' : 'bg-yellow-500/10 border border-yellow-500/20'}">
                      <span class="text-lg">${a.severity === 'critical' ? 'ðŸ”´' : 'ðŸŸ¡'}</span>
                      <div class="text-sm ${a.severity === 'critical' ? 'text-red-300' : 'text-yellow-300'}">${esc(a.message)}</div>
                    </div>
                  `).join("")}
                </div>
              </div>
            ` : ""}

            <!-- Per-account breakdown -->
            <div class="glass-strong p-5">
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Account Performance</h3>
              <div class="space-y-3">
                ${metrics.length > 0 ? metrics.map(m => {
                  const platform = m.platform === 'meta' ? 'Meta' : 'Google Ads';
                  const platformColor = m.platform === 'meta' ? 'text-blue-400' : 'text-green-400';
                  return `
                    <div class="p-4 rounded-lg bg-surface-800/50 border border-slate-800/50">
                      <div class="flex items-center justify-between mb-3">
                        <div>
                          <span class="font-medium ${platformColor}">${platform}</span>
                          <span class="text-slate-500 text-sm ml-2">${esc(m.accountId)}</span>
                        </div>
                        <div class="text-xl font-bold text-white">$${m.spend.toFixed(0)}</div>
                      </div>
                      <div class="grid grid-cols-4 gap-3 text-sm">
                        <div>
                          <div class="text-slate-500 text-xs">CPC</div>
                          <div class="text-slate-300">$${m.cpc.toFixed(2)}</div>
                        </div>
                        <div>
                          <div class="text-slate-500 text-xs">CPM</div>
                          <div class="text-slate-300">$${m.cpm.toFixed(2)}</div>
                        </div>
                        <div>
                          <div class="text-slate-500 text-xs">CTR</div>
                          <div class="text-slate-300">${m.ctr.toFixed(2)}%</div>
                        </div>
                        <div>
                          <div class="text-slate-500 text-xs">Conv Rate</div>
                          <div class="text-slate-300">${m.conversionRate.toFixed(2)}%</div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join("") : '<div class="text-slate-600 text-center py-6">No data yet â€” first check runs 2 min after startup</div>'}
              </div>
              <div class="text-xs text-slate-600 mt-3">Last checked: ${esc(lastCheck)} &bull; Checks every 30 min</div>
            </div>
          `}
        </div>
      `;
    }

    // Tab navigation
    const tabHandlers = { overview: showOverview, messages: showMessages, memory: showMemory, contacts: showContacts, todos: showTodos, habits: showHabits, ads: showAds, logs: showLogs };
    let currentTab = "overview";

    document.getElementById("tabs").addEventListener("click", (e) => {
      const tab = e.target.closest(".tab");
      if (!tab) return;
      const name = tab.dataset.tab;
      currentTab = name;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("tab-active"));
      tab.classList.add("tab-active");
      document.getElementById("content").innerHTML = '<div class="flex justify-center py-12"><div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>';
      tabHandlers[name]?.();
    });

    // Auto-refresh every 30 seconds
    setInterval(() => tabHandlers[currentTab]?.(), 30000);

    // Load overview
    showOverview();
  </script>
</body>
</html>
