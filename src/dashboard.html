<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raya Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #1e293b; border-radius: 12px; padding: 1.5rem; }
    .tab-active { background: #3b82f6; color: white; }
    .tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; }
    .tab:hover { background: #334155; }
    .streak { color: #f59e0b; font-weight: bold; }
    .done { color: #22c55e; }
    .pending { color: #f97316; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-white">Raya Dashboard</h1>
      <div id="stats-bar" class="text-sm text-slate-400"></div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-6 flex-wrap" id="tabs">
      <div class="tab tab-active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="messages">Messages</div>
      <div class="tab" data-tab="memory">Memory</div>
      <div class="tab" data-tab="todos">Todos</div>
      <div class="tab" data-tab="habits">Habits</div>
      <div class="tab" data-tab="logs">Logs</div>
    </div>

    <!-- Content -->
    <div id="content"></div>
  </div>

  <script>
    const TOKEN = "__TOKEN__";
    const BASE = window.location.origin;

    async function api(path) {
      const res = await fetch(`${BASE}${path}?token=${TOKEN}`);
      return res.json();
    }

    function timeAgo(dateStr) {
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      return `${Math.floor(hrs / 24)}d ago`;
    }

    function esc(str) {
      const d = document.createElement("div");
      d.textContent = str || "";
      return d.innerHTML;
    }

    async function showOverview() {
      const [stats, todos, habits, msgs] = await Promise.all([
        api("/api/stats"),
        api("/api/todos"),
        api("/api/habits"),
        api("/api/messages"),
      ]);

      const upH = Math.floor((stats.uptime || 0) / 3600);
      const upM = Math.floor(((stats.uptime || 0) % 3600) / 60);

      document.getElementById("stats-bar").textContent =
        `Uptime: ${upH}h ${upM}m`;

      const todayStr = new Date().toLocaleDateString("en-US");
      const habitsData = habits.habits || [];
      const habitsDone = habitsData.filter(h =>
        h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr
      ).length;

      const activeTodos = (todos.active || []).length;
      const recentMsgs = (msgs.messages || []).slice(0, 5);

      document.getElementById("content").innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="card text-center">
            <div class="text-3xl font-bold text-blue-400">${stats.facts || 0}</div>
            <div class="text-sm text-slate-400">Facts</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold text-purple-400">${stats.goals || 0}</div>
            <div class="text-sm text-slate-400">Goals</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold text-orange-400">${activeTodos}</div>
            <div class="text-sm text-slate-400">Active Todos</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold text-green-400">${habitsDone}/${habitsData.length}</div>
            <div class="text-sm text-slate-400">Habits Today</div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="card">
            <h3 class="text-lg font-semibold mb-3 text-white">Recent Messages</h3>
            ${recentMsgs.map(m => `
              <div class="mb-2 text-sm">
                <span class="badge ${m.role === "user" ? "bg-blue-900 text-blue-300" : "bg-green-900 text-green-300"}">${m.role}</span>
                <span class="text-slate-500 ml-1">${timeAgo(m.created_at)}</span>
                <div class="mt-1 text-slate-300">${esc(m.content?.substring(0, 120))}${m.content?.length > 120 ? "..." : ""}</div>
              </div>
            `).join("") || '<div class="text-slate-500">No messages yet</div>'}
          </div>

          <div class="card">
            <h3 class="text-lg font-semibold mb-3 text-white">Habits</h3>
            ${habitsData.map(h => {
              const done = h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr;
              return `<div class="mb-2 text-sm flex justify-between">
                <span>${done ? '<span class="done">&#10003;</span>' : '<span class="pending">&#9675;</span>'} ${esc(h.content)}</span>
                <span class="streak">${h.priority ? h.priority + " day streak" : ""}</span>
              </div>`;
            }).join("") || '<div class="text-slate-500">No habits tracked</div>'}
          </div>
        </div>
      `;
    }

    async function showMessages() {
      const data = await api("/api/messages");
      const msgs = data.messages || [];
      document.getElementById("content").innerHTML = `
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-white">Conversation History</h3>
          ${msgs.map(m => `
            <div class="mb-3 pb-3 border-b border-slate-700">
              <div>
                <span class="badge ${m.role === "user" ? "bg-blue-900 text-blue-300" : "bg-green-900 text-green-300"}">${m.role}</span>
                <span class="text-slate-500 text-sm ml-2">${new Date(m.created_at).toLocaleString()}</span>
              </div>
              <div class="mt-1 text-slate-300 text-sm whitespace-pre-wrap">${esc(m.content?.substring(0, 500))}${m.content?.length > 500 ? "..." : ""}</div>
            </div>
          `).join("") || '<div class="text-slate-500">No messages</div>'}
        </div>
      `;
    }

    async function showMemory() {
      const data = await api("/api/memory");
      document.getElementById("content").innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card">
            <h3 class="text-lg font-semibold mb-3 text-white">Facts (${(data.facts || []).length})</h3>
            ${(data.facts || []).map(f => `
              <div class="mb-2 text-sm text-slate-300">- ${esc(f.content)}</div>
            `).join("") || '<div class="text-slate-500">No facts stored</div>'}
          </div>
          <div>
            <div class="card mb-4">
              <h3 class="text-lg font-semibold mb-3 text-white">Active Goals (${(data.goals || []).length})</h3>
              ${(data.goals || []).map(g => `
                <div class="mb-2 text-sm text-slate-300">- ${esc(g.content)}${g.deadline ? ` <span class="text-yellow-400">(by ${g.deadline})</span>` : ""}</div>
              `).join("") || '<div class="text-slate-500">No active goals</div>'}
            </div>
            <div class="card">
              <h3 class="text-lg font-semibold mb-3 text-white">Completed Goals</h3>
              ${(data.completedGoals || []).map(g => `
                <div class="mb-2 text-sm text-slate-500 line-through">${esc(g.content)}</div>
              `).join("") || '<div class="text-slate-500">None yet</div>'}
            </div>
          </div>
        </div>
      `;
    }

    async function showTodos() {
      const data = await api("/api/todos");
      document.getElementById("content").innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card">
            <h3 class="text-lg font-semibold mb-3 text-white">Active (${(data.active || []).length})</h3>
            ${(data.active || []).map(t => `
              <div class="mb-2 text-sm text-slate-300">
                <span class="pending">&#9675;</span> ${esc(t.content)}
                ${t.deadline ? `<span class="text-yellow-400 text-xs ml-1">(due ${t.deadline})</span>` : ""}
              </div>
            `).join("") || '<div class="text-slate-500">All clear!</div>'}
          </div>
          <div class="card">
            <h3 class="text-lg font-semibold mb-3 text-white">Completed</h3>
            ${(data.completed || []).map(t => `
              <div class="mb-2 text-sm text-slate-500">
                <span class="done">&#10003;</span> <span class="line-through">${esc(t.content)}</span>
                <span class="text-xs ml-1">${timeAgo(t.completed_at)}</span>
              </div>
            `).join("") || '<div class="text-slate-500">None yet</div>'}
          </div>
        </div>
      `;
    }

    async function showHabits() {
      const data = await api("/api/habits");
      const habits = data.habits || [];
      const todayStr = new Date().toLocaleDateString("en-US");

      document.getElementById("content").innerHTML = `
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-white">Habits</h3>
          ${habits.map(h => {
            const done = h.updated_at && new Date(h.updated_at).toLocaleDateString("en-US") === todayStr;
            const streak = h.priority || 0;
            return `
              <div class="mb-3 pb-3 border-b border-slate-700 flex justify-between items-center">
                <div>
                  <span class="${done ? "done" : "pending"}">${done ? "&#10003;" : "&#9675;"}</span>
                  <span class="text-slate-300 ml-1">${esc(h.content)}</span>
                  <span class="badge bg-slate-700 text-slate-400 ml-2">${h.deadline || "daily"}</span>
                </div>
                <div class="text-right">
                  ${streak > 0 ? `<div class="streak">${streak} day${streak > 1 ? "s" : ""}</div>` : ""}
                  ${h.updated_at ? `<div class="text-xs text-slate-500">Last: ${timeAgo(h.updated_at)}</div>` : ""}
                </div>
              </div>
            `;
          }).join("") || '<div class="text-slate-500">No habits tracked yet. Tell Raya to add one!</div>'}
        </div>
      `;
    }

    async function showLogs() {
      const data = await api("/api/logs");
      const logs = data.logs || [];

      document.getElementById("content").innerHTML = `
        <div class="card">
          <h3 class="text-lg font-semibold mb-4 text-white">Recent Logs</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-slate-400 border-b border-slate-700">
                  <th class="text-left py-2">Time</th>
                  <th class="text-left py-2">Event</th>
                  <th class="text-left py-2">Message</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(l => `
                  <tr class="border-b border-slate-800">
                    <td class="py-2 text-slate-500 whitespace-nowrap">${new Date(l.created_at).toLocaleString()}</td>
                    <td class="py-2"><span class="badge bg-slate-700">${esc(l.event)}</span></td>
                    <td class="py-2 text-slate-300">${esc(l.message?.substring(0, 200))}</td>
                  </tr>
                `).join("") || '<tr><td colspan="3" class="text-slate-500 py-4">No logs yet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Tab navigation
    const tabHandlers = {
      overview: showOverview,
      messages: showMessages,
      memory: showMemory,
      todos: showTodos,
      habits: showHabits,
      logs: showLogs,
    };

    document.getElementById("tabs").addEventListener("click", (e) => {
      const tab = e.target.closest(".tab");
      if (!tab) return;
      const name = tab.dataset.tab;

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("tab-active"));
      tab.classList.add("tab-active");

      tabHandlers[name]?.();
    });

    // Load overview on start
    showOverview();
  </script>
</body>
</html>
